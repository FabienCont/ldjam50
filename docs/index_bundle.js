(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})}};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var r=e.g.document;if(!t&&r&&(r.currentScript&&(t=r.currentScript.src),!t)){var n=r.getElementsByTagName("script");n.length&&(t=n[n.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})();var t={};e.r(t),e.d(t,{moveBackwardCamera:()=>b,moveBottomCamera:()=>M,moveForwardCamera:()=>_,moveLeftCamera:()=>w,moveLeftHero:()=>P,moveRightCamera:()=>C,moveRightHero:()=>I,moveTopCamera:()=>E,rotateLeftCamera:()=>S,rotateRightCamera:()=>A,stopMoveLeftHero:()=>L,stopMoveRightHero:()=>N,zoomCamera:()=>T});var r={};e.r(r),e.d(r,{collideSystem:()=>H,goForwardSystem:()=>$,moveHeroSystem:()=>q});class n{xmag;ymag;zfar;znear;constructor({xmag:e,ymag:t,zfar:r,znear:n}={}){this.xmag=e??1,this.ymag=t??1,this.zfar=r??100,this.znear=n??.01}getProjectionMatrix(){console.error("not implemented yet")}}let s=Float32Array;function o(e,t,r){r=r||new s(16);const n=t[0],o=t[1],i=t[2],a=t[3],l=t[4],u=t[5],c=t[6],h=t[7],d=t[8],m=t[9],p=t[10],f=t[11],g=t[12],v=t[13],x=t[14],T=t[15],b=e[0],_=e[1],E=e[2],y=e[3],w=e[4],C=e[5],M=e[6],R=e[7],S=e[8],A=e[9],P=e[10],I=e[11],L=e[12],N=e[13],U=e[14],B=e[15];return r[0]=n*b+o*w+i*S+a*L,r[1]=n*_+o*C+i*A+a*N,r[2]=n*E+o*M+i*P+a*U,r[3]=n*y+o*R+i*I+a*B,r[4]=l*b+u*w+c*S+h*L,r[5]=l*_+u*C+c*A+h*N,r[6]=l*E+u*M+c*P+h*U,r[7]=l*y+u*R+c*I+h*B,r[8]=d*b+m*w+p*S+f*L,r[9]=d*_+m*C+p*A+f*N,r[10]=d*E+m*M+p*P+f*U,r[11]=d*y+m*R+p*I+f*B,r[12]=g*b+v*w+x*S+T*L,r[13]=g*_+v*C+x*A+T*N,r[14]=g*E+v*M+x*P+T*U,r[15]=g*y+v*R+x*I+T*B,r}function i(e,t,r){return(r=r||new s(3))[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r}function a(e,t,r){return(r=r||new s(3))[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r}function l(e,t){t=t||new s(3);const r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return r>1e-5&&(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r),t}function u(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function c(e){return(e=e||new s(16))[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function h(e,t,r){r=r||new s(16);const n=e[0],o=e[1],i=e[2],a=e[3],l=e[8],u=e[9],c=e[10],h=e[11],d=Math.cos(t),m=Math.sin(t);return r[0]=d*n-m*l,r[1]=d*o-m*u,r[2]=d*i-m*c,r[3]=d*a-m*h,r[8]=d*l+m*n,r[9]=d*u+m*o,r[10]=d*c+m*i,r[11]=d*h+m*a,e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r}function d(e){const t=e[0],r=e[1],n=e[2],s=e[3],o=e[4],i=e[5],a=e[6],l=e[7],u=e[8],c=e[9],h=e[10],d=e[11],m=e[12],p=e[13],f=e[14],g=e[15],v=h*g,x=f*d,T=a*g,b=f*l,_=a*d,E=h*l,y=n*g,w=f*s,C=n*d,M=h*s,R=n*l,S=a*s;return 1/(t*(v*i+b*c+_*p-(x*i+T*c+E*p))+o*(x*r+y*c+M*p-(v*r+w*c+C*p))+u*(T*r+w*i+R*p-(b*r+y*i+S*p))+m*(E*r+C*i+S*c-(_*r+M*i+R*c)))}function m(e){const t=new s(16),r=e[0],n=e[1],o=e[2],i=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],m=e[10],p=e[11],f=e[12],g=e[13],v=e[14],x=e[15],T=m*x,b=v*p,_=u*x,E=v*c,y=u*p,w=m*c,C=o*x,M=v*i,R=o*p,S=m*i,A=o*c,P=u*i,I=h*g,L=f*d,N=a*g,U=f*l,B=a*d,F=h*l,k=r*g,D=f*n,O=r*d,z=h*n,X=r*l,V=a*n,G=T*l+E*d+y*g-(b*l+_*d+w*g),j=b*n+C*d+S*g-(T*n+M*d+R*g),W=_*n+M*l+A*g-(E*n+C*l+P*g),$=w*n+R*l+P*d-(y*n+S*l+A*d),H=r*G+a*j+h*W+f*$;if(0===H)return new s(16);const q=1/H;return t[0]=q*G,t[1]=q*j,t[2]=q*W,t[3]=q*$,t[4]=q*(b*a+_*h+w*f-(T*a+E*h+y*f)),t[5]=q*(T*r+M*h+R*f-(b*r+C*h+S*f)),t[6]=q*(E*r+C*a+P*f-(_*r+M*a+A*f)),t[7]=q*(y*r+S*a+A*h-(w*r+R*a+P*h)),t[8]=q*(I*c+U*p+B*x-(L*c+N*p+F*x)),t[9]=q*(L*i+k*p+z*x-(I*i+D*p+O*x)),t[10]=q*(N*i+D*c+X*x-(U*i+k*c+V*x)),t[11]=q*(F*i+O*c+V*p-(B*i+z*c+X*p)),t[12]=q*(N*m+F*v+L*u-(B*v+I*u+U*m)),t[13]=q*(O*v+I*o+D*m-(k*m+z*v+L*o)),t[14]=q*(k*u+V*v+U*o-(X*v+N*o+D*u)),t[15]=q*(X*m+B*o+z*u-(O*u+V*m+F*o)),t}function p(e,t){return(t=t||new s(16))[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}class f{aspectRatio;yfov;zfar;znear;constructor({aspectRatio:e,yfov:t,zfar:r,znear:n}={}){this.aspectRatio=e??1,this.yfov=t??1,this.zfar=r??1e3,this.znear=n??.001}getProjectionMatrix(e){let t=1;return e&&e.canvas&&(t=e.canvas.clientWidth/e.canvas.clientHeight),function(e,t,r,n,o){o=o||new s(16);const i=Math.tan(.5*Math.PI-.5*e),a=1/(r-n);return o[0]=i/t,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=(r+n)*a,o[11]=-1,o[12]=0,o[13]=0,o[14]=r*n*a*2,o[15]=0,o}(this.yfov,this.aspectRatio*t,this.znear,this.zfar)}}const g=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))};class v{uuid;ref;name;children;parent;mesh;matrix;matrixWorld;isTRS;rotation;translation;scale;weights;skin;extensions;constructor({name:e,children:t,parent:r,matrix:n,rotation:s,scale:o,translation:i}={},a){this.uuid=g(),this.name=e,void 0!==a&&(this.ref=a),this.parent=r,this.children=t??[],o||s||i?(this.isTRS=!0,this.scale=o||[1,1,1],this.rotation=s||[0,0,0,1],this.translation=i||[0,0,0],this.updateMatrixFromTRS()):(this.matrix=n?p(n):c(),this.scale=[1,1,1],this.rotation=[0,0,0,1],this.translation=[0,0,0],this.updateTRSFromMatrix()),this.matrixWorld=p(this.matrix)}addChildNode(e){this.children.push(e)}addMeshToNode(e){this.mesh=e}removeChild(e){let t=this.children.indexOf(e);this.children.splice(t,1)}updateMatrixFromTRS(){this.matrix=function(e,t,r,n){n=n||new s(16);const o=t[0],i=t[1],a=t[2],l=t[3],u=o+o,c=i+i,h=a+a,d=o*u,m=o*c,p=o*h,f=i*c,g=i*h,v=a*h,x=l*u,T=l*c,b=l*h,_=r[0],E=r[1],y=r[2];return n[0]=(1-(f+v))*_,n[1]=(m+b)*_,n[2]=(p-T)*_,n[3]=0,n[4]=(m-b)*E,n[5]=(1-(d+v))*E,n[6]=(g+x)*E,n[7]=0,n[8]=(p+T)*y,n[9]=(g-x)*y,n[10]=(1-(d+f))*y,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}(this.translation,this.rotation,this.scale)}updateTRSFromMatrix(){!function(e,t,r,n){let s=u(e.slice(0,3));const o=u(e.slice(4,7)),i=u(e.slice(8,11));d(e)<0&&(s=-s),t[0]=e[12],t[1]=e[13],t[2]=e[14];const a=p(e),l=1/s,c=1/o,h=1/i;a[0]*=l,a[1]*=l,a[2]*=l,a[4]*=c,a[5]*=c,a[6]*=c,a[8]*=h,a[9]*=h,a[10]*=h,function(e,t){const r=e[0],n=e[4],s=e[8],o=e[1],i=e[5],a=e[9],l=e[2],u=e[6],c=e[10],h=r+i+c;if(h>0){const e=.5/Math.sqrt(h+1);t[3]=.25/e,t[0]=(u-a)*e,t[1]=(s-l)*e,t[2]=(o-n)*e}else if(r>i&&r>c){const e=2*Math.sqrt(1+r-i-c);t[3]=(u-a)/e,t[0]=.25*e,t[1]=(n+o)/e,t[2]=(s+l)/e}else if(i>c){const e=2*Math.sqrt(1+i-r-c);t[3]=(s-l)/e,t[0]=(n+o)/e,t[1]=.25*e,t[2]=(a+u)/e}else{const e=2*Math.sqrt(1+c-r-i);t[3]=(o-n)/e,t[0]=(s+l)/e,t[1]=(a+u)/e,t[2]=.25*e}}(a,r),n[0]=s,n[1]=o,n[2]=i}(this.matrix,this.translation,this.rotation,this.scale)}update(){this.parent?o(this.parent.matrixWorld,this.matrix,this.matrixWorld):p(this.matrix,this.matrixWorld),this.updateChildren()}copyPos(e){this.matrix=p(e.matrix),this.rotation=JSON.parse(JSON.stringify(e.rotation)),this.translation=JSON.parse(JSON.stringify(e.translation)),this.scale=JSON.parse(JSON.stringify(e.scale))}updateChildren(){this.children&&this.children.forEach((e=>{!e||e.update,e.update()}))}}class x{uuid;name;info;type;projectionMatrix;node;matrixWorld;constructor(e={}){if(this.uuid=g(),this.type=e.type,"perspective"===this.type)this.info=new f(e);else{if("orthographic"!==this.type)throw new Error(`type :${type} does not exist`);this.info=new n(e)}}update(e){this.projectionMatrix=this.info.getProjectionMatrix(e),this.worldPosition=[this.node.matrixWorld[12],this.node.matrixWorld[13],this.node.matrixWorld[14]],this.matrixWorld=this.node.matrixWorld,this.viewMatrix=m(this.matrixWorld),this.viewProjectionMatrix=o(this.projectionMatrix,this.viewMatrix)}}function T(e,t,r,n){let s=t.camera.node;s.isTRS?(s.translation[0]+=Math.sign(y),s.updateMatrixFromTRS()):s.matrix[12]+=Math.sign(y)}function b(e,t,r,n){let s=t.camera.node;s.isTRS?(s.translation[2]+=1,s.updateMatrixFromTRS()):s.matrix[14]+=1}function _(e,t,r,n){let s=t.camera.node;s.isTRS?(s.translation[2]-=1,s.updateMatrixFromTRS()):s.matrix[14]-=1}function E(e,t,r,n){let s=t.camera.node;s.isTRS?(s.translation[1]+=1,s.updateMatrixFromTRS()):s.matrix[12]+=1}function w(e,t,r,n){let s=t.camera.node;s.isTRS?(s.translation[0]-=1,s.updateMatrixFromTRS()):s.matrix[12]-=1}function C(e,t,r,n){let s=t.camera.node;s.isTRS?(s.translation[0]+=1,s.updateMatrixFromTRS()):s.matrix[12]+=1}function M(e,t,r,n){let s=t.camera.node;s.isTRS?(s.translation[1]-=1,s.updateMatrixFromTRS()):s.matrix[12]-=1}function R(e){return e*Math.PI/180}function S(e,t,r,n){let s=t.camera.node;s.isTRS?(s.updateMatrixFromTRS(),s.matrix=h(s.matrix,R(2)),s.updateTRSFromMatrix()):s.matrix=h(s.matrix,R(2))}function A(e,t,r,n){let s=t.camera.node;s.isTRS?(s.updateMatrixFromTRS(),s.matrix=h(s.matrix,R(-2)),s.updateTRSFromMatrix()):s.matrix=h(s.matrix,R(-2))}function P(e,t,r,n){r.temp.moveLeft=!0}function I(e,t,r,n){r.temp.moveRight=!0}function L(e,t,r,n){r.temp.moveLeft=!1}function N(e,t,r,n){r.temp.moveRight=!1}Object.freeze({NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648});const U=Object.freeze({5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),B=(Object.freeze({5120:1,5121:1,5122:2,5123:2,5125:4,5126:4}),Object.freeze({SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16})),F=Object.freeze({POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"}),k=(Object.freeze({FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123}),function(e,t){return e.map(((e,r)=>e-t[r]))}),D=function(e){return function(e,t){return function(e,t){return[t[0]*e,t[1]*e,t[2]*e]}(1/e,t)}(function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}(e)||1,e)},O=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},z=function(e,t){const r=e[0],n=e[1],s=e[2],o=t[0],i=t[1],a=t[2];return[n*a-s*i,s*o-r*a,r*i-n*o]};class X{name;nodes;matrixWorld;constructor({name:e,nodes:t}={}){this.name=e,this.nodes=t,this.matrixWorld=c()}update(){this.nodes.forEach((e=>{e.update()}))}}class V{systems;constructor(){this.systems=new Map}set(e){this.systems.set(e.uuid,e)}update(e,t,r){!function(e,t,r){r.inputs.forEach((n=>{let s=t.commands.get(n.controller+n.action+(n.input??""));if(s){let o=t.scripts.get(s);o&&o(e,t,r,n)}}))}(e,t,r),this.systems.forEach((n=>{n.script(e,t,r)}))}}class G{name;animations;scene;nodes;lights;camera;cameras;meshes;skins;materials;commands;systems;scripts;constructor({name:e}={}){this.name=e,this.scene=new X,this.camera=0,this.commands=[],this.cameras=new Map,this.lights=new Map,this.meshes=new Map,this.nodes=new Map,this.commands=new Map,this.scripts=new Map,this.animations=new Map,this.systems=new V}createChildNode(e){let t=this.nodes.get(e),r=new v({});this.nodes.set(r.uuid,r),t.addChildNode(r)}addMesh(e){this.meshes.set(e.uuid,e)}deleteNode(e){this.nodes.delete(e.uuid)}findNode(e,t){let r=!1;for(let n=0;n<e.length;n++){const s=e[n];if(t(s)){r=s;break}if(s.children&&(r=this.findNode(s.children,t),r))break}return r}findAllNodes(e,t,r=[]){for(let n=0;n<e.length;n++){const s=e[n];t(s)&&r.push(s),s.children&&this.findAllNodes(s.children,t,r)}return r}}class j{name;uuid;script;constructor({name:e,script:t}){this.uuid=g(),e&&(this.name=e),t&&(this.script=t)}}class W{constructor(e){this.asset=null,this.filePath="",this.cache={},this.levelBlueprint=null,this.level=null,this.loadUri=this.memoize(this.loadUri),this.loadMesh=this.memoize(this.loadMesh),this.loadMaterial=this.memoize(this.loadMaterial),this.loadDefaultMaterial=this.memoize(this.loadDefaultMaterial),this.loadImage=this.memoize(this.loadImage),this.loadSkin=this.memoize(this.loadSkin),this.loadTexture=this.memoize(this.loadTexture),this.loadBufferView=this.memoize(this.loadBufferView),this.loadBuffer=this.memoize(this.loadBuffer),this.loadAccessors=this.memoize(this.loadAccessors),this.loadChannel=this.memoize(this.loadChannel),this.loadAnimationSampler=this.memoize(this.loadAnimationSampler),this.loadSampler=this.memoize(this.loadSampler),this.fileLoader=e}loadArg(e){return"string"!=typeof e?JSON.stringify(e):e}memoize(e){return(...t)=>new Promise((r=>{const n=this.loadArg(t[0]);let s,o=`${e.name}_${n}`;t[1]&&(o=`${o}_${this.loadArg(t[2])}`),this.cache.hasOwnProperty(o)?s=this.cache[o]:(s=e.apply(this,t),this.cache[o]=s),Promise.resolve(s).then((e=>{r(e)}))}))}async loadRef(e){return await this.fileLoader.loadRef(e)}async loadUri(e,{byteLength:t,needBlob:r=!1}){const n=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(n){const e=n[1];let t=n[3];if(t=decodeURIComponent(t),n[2]&&(t=atob(t)),r){const r=512,n=[];for(let e=0;e<t.length;e+=r){const s=t.slice(e,e+r),o=new Array(s.length);for(let e=0;e<s.length;e+=1)o[e]=s.charCodeAt(e);const i=new Uint8Array(o);n.push(i)}return new Blob(n,{type:e})}{const e=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)e[r]=t.charCodeAt(r);return e.buffer}}return e.startsWith("./")&&(e=e.substring(2)),await this.fileLoader.loadRef({uri:this.filePath+"/"+e})}loadBuffer(e){return new Promise((t=>{const r=this.levelBlueprint.buffers[e];void 0===r.uri&&0===e?t(gltf.glbBody):this.loadUri(r.uri,{byteLength:r.byteLength}).then((e=>{t(e)}))}))}loadBufferView(e){return new Promise((t=>{const r=this.levelBlueprint.bufferViews[e];this.loadBuffer(r.buffer).then((e=>{const n=r.byteLength||0,s=r.byteOffset||0,o=e.slice(s,s+n);t(o)}))}))}loadMatrix4(e){return p(e)}loadVec2(e){return e}loadVec3(e){return e}loadVec4(e){return e}loadSampler(e){return this.levelBlueprint.samplers[e]}loadChannel(e,t){return new Promise((r=>{const n=this.levelBlueprint.animations[e].channels[t],s=[],o={target:{}};s.push(this.loadAnimationSampler(e,n.sampler).then((e=>{o.sampler=e}))),s.push(this.loadNode(n.target.node).then((e=>{o.target.node=e}))),o.target.path=n.target.path,Promise.all(s).then((()=>{r(o)}))}))}loadAnimationSampler(e,t){return new Promise((r=>{const n=this.levelBlueprint.animations[e].samplers[t],s=[],o={};s.push(this.loadAccessors(n.input).then((e=>{o.input=e}))),s.push(this.loadAccessors(n.output).then((e=>{o.output=e}))),o.interpolation=n.interpolation?n.interpolation:"LINEAR",Promise.all(s).then((()=>{o.valueSize=o.output.count/o.input.count,r(o)}))}))}loadCamera(e){return this.levelBlueprint.cameras[e]}loadSkin(e){return new Promise((t=>{const r=this.levelBlueprint.skins[e],n={joints:[],jointMatrices:[]},s=[];if(n.inverseBindMatrices=[],r.joints.forEach(((e,t)=>{s.push(this.loadNode(e).then((r=>{r.isJoint=!0,r.indexJoint=e,n.jointMatrices[t]=c(),n.joints[t]=r})))})),r.skeleton&&s.push(this.loadNode(r.skeleton).then((e=>{e.isSkeleton=!0,n.skeleton=e}))),r.inverseBindMatrices)s.push(this.loadAccessors(r.inverseBindMatrices).then((e=>{n.inverseBindMatrices=[];for(let t=0;t<e.count;t+=1)n.inverseBindMatrices.push(e.array.slice(e.offset+t*e.itemSize,e.offset+t*e.itemSize+e.itemSize))})));else for(let e=0;e<r.joints.length;e+=1)n.inverseBindMatrices.push(c());r.name&&(n.name=r.name),r.extensions&&(n.extensions=r.extensions),r.extras&&(n.extras=r.extras),Promise.all(s).then((e=>{t(n)}))}))}loadImage(e){return new Promise((t=>{const r=this.levelBlueprint.images[e];let n={};const s=[];r.uri?s.push(new Promise((e=>{this.loadUri(r.uri,{needBlob:!0}).then((t=>{createImageBitmap(t).then((t=>{n=t,e(t)})).catch((e=>{console.log(e)}))}))}))):s.push(this.loadBufferView(e).then((e=>{const t=new Blob([e],{type:r.mimeType});n=t}))),Promise.all(s).then((e=>{t(n)}))}))}loadTexture(e){return new Promise((t=>{const r=this.levelBlueprint.textures[e],n={uuid:g()},s=[];s.push(this.loadImage(r.source).then((e=>{n.image=e})));let o=null;o="number"==typeof r.sampler?this.loadSampler(r.sampler):new Promise((e=>{e({})})),s.push(o.then((e=>{n.magFilter=e.magFilter||9729,n.minFilter=e.minFilter||9987,n.wrapS=e.wrapS||10497,n.wrapT=e.wrapT||10497}))),Promise.all(s).then((e=>{t(n)}))}))}loadPbrMetallicRoughness(e){return new Promise((t=>{const r=[],n={baseColorFactor:[1,1,1,1]};Array.isArray(e.baseColorFactor)&&(n.baseColorFactor=e.baseColorFactor),void 0!==e.baseColorTexture&&r.push(this.loadTexture(e.baseColorTexture.index).then((t=>{n.baseColorTexture={texture:t,texCoord:0},"number"==typeof e.baseColorTexture.texCoord&&(n.baseColorTexture.texCoord=e.baseColorTexture.texCoord)}))),n.metalness=void 0!==e.metallicFactor?e.metallicFactor:1,n.roughness=void 0!==e.roughnessFactor?e.roughnessFactor:1,void 0!==e.metallicRoughnessTexture&&r.push(this.loadTexture(e.metallicRoughnessTexture.index).then((t=>{n.metallicRoughnessTexture={texture:t,texCoord:0},"number"==typeof e.metallicRoughnessTexture.texCoord&&(n.metallicRoughnessTexture.texCoord=e.metallicRoughnessTexture.texCoord)}))),Promise.all(r).then((()=>{t(n)}))}))}loadDefaultMaterial(){return new Promise((e=>{e({name:"defaultMaterial",emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,metallicRoughness:{baseColorFactor:[1,1,1,1],metalness:1,roughness:1}})}))}loadMaterial(e){return new Promise((t=>{const r=this.levelBlueprint.materials[e],n=[],s={};if(s.name=r.name,n.push(this.loadPbrMetallicRoughness(r.pbrMetallicRoughness||{}).then((e=>{s.metallicRoughness=e}))),r.normalTexture&&n.push(this.loadTexture(r.normalTexture.index).then((e=>{const{normalTexture:t}=r;s.normalTextureInfo={texture:e,strength:"number"==typeof t.scale?t.scale:1,texCoord:0},"number"==typeof t.texCoord&&(s.normalTextureInfo.texCoord=t.texCoord),t.extensions&&(console.error("material extensions not handle"),s.normalTextureInfo.extensions=t.extensions),t.extras&&(console.error("material extras not handle"),s.normalTextureInfo.extras=t.extras)}))),r.occlusionTexture){const{occlusionTexture:e}=r;n.push(this.loadTexture(r.occlusionTexture.index).then((t=>{s.occlusionTextureInfo={texture:t,strength:"number"==typeof e.strength?e.strength:1,texCoord:0},"number"==typeof e.texCoord&&(s.occlusionTextureInfo.texCoord=e.texCoord),e.extensions&&(console.error("material extensions not handle"),s.occlusionTextureInfo.extensions=e.extensions),e.extras&&(console.error("material extras not handle"),s.occlusionTextureInfo.extras=e.extras)})))}r.emissiveTexture&&n.push(this.loadTexture(r.emissiveTexture.index).then((e=>{s.emissiveTexture={texture:e,texCoord:0},"number"==typeof r.emissiveTexture.texCoord&&(s.emissiveTexture.texCoord=r.emissiveTexture.texCoord)}))),r.extensions&&(console.error("material extensions not handle"),s.extensions=r.extensions),r.extras&&(console.error("material extras not handle"),s.extras=r.extras),s.emissiveFactor=r.emissiveFactor?r.emissiveFactor:[0,0,0],s.alphaMode=r.alphaMode?r.alphaMode:"OPAQUE","MASK"===s.alphaMode?s.alphaCutoff=r.alphaCutoff?r.alphaCutoff:.5:s.alphaCutoff=0,s.doubleSided="boolean"==typeof r.doubleSided&&r.doubleSided,Promise.all(n).then((()=>{t(s)}))}))}checkForUnknownTextureProperty(e){const t=Object.entries(e);for(let e=0;e<t.length;e+=1){const[r,n]=t[e];switch(r){case"name":case"pbrMetallicRoughness":case"normalTexture":case"occlusionTexture":case"emissiveTexture":case"emissiveFactor":break;default:console.error(`material key ${r} not known`)}}}async loadAttributes(e){const t=[],r=Object.entries(e),n={};for(let e=0;e<r.length;e+=1){const[s,o]=r[e];t.push(this.loadAccessors(o).then((e=>{n[F[s]]=e})))}return await Promise.all(t),n}async loadAccessors(e){const t=this.levelBlueprint.accessors[e],r=[];void 0!==t.bufferView&&r.push(this.loadBufferView(t.bufferView)),void 0!==t.sparse&&(r.push(this.loadBufferView(t.sparse.indices.bufferView)),r.push(this.loadBufferView(t.sparse.values.bufferView)));const n=B[t.type],s=U[t.componentType],o=s.BYTES_PER_ELEMENT,i=o*n,a=await Promise.all(r),l=a[0],u=t.byteOffset||0,c=void 0!==t.bufferView?this.levelBlueprint.bufferViews[t.bufferView].byteStride:void 0,h=!0===t.normalized;let d,m={};if(c&&c!==i?(d=new s(l,Math.floor(u/c)*c,t.count*c/o),m={min:t.min,max:t.max,array:d,componentType:t.componentType,count:t.count,itemSize:n,normalized:h,offset:u%c,stride:c}):(d=null===l?new s(t.count*n):new s(l,u,t.count*n),m={min:t.min,max:t.max,array:d,componentType:t.componentType,count:t.count,itemSize:n,offset:0,normalized:h}),void 0!==t.sparse){const e=a[1],r=a[2],o=new(0,U[t.sparse.indices.componentType])(e,t.sparse.indices.byteOffset,t.sparse.count);let i;i=null===r?new s(t.sparse.count*n):new s(r,t.sparse.values.byteOffset,t.sparse.count*n);for(let e=0;e<t.sparse.count;e+=1){const t=o[e]*n,r=e*n;for(let e=0;e<n;e+=1)m.array[t+e]=i[r+e]}}return m}loadTargets(e){return new Promise((t=>{const r=[],n=[];e.forEach(((e,t)=>{r.push(this.loadAttributes(e).then((e=>{n[t]=e})))})),Promise.all(r).then((()=>{t(n)}))}))}async loadPrimitive(e){const t={},r=[];return e.attributes&&r.push(this.loadAttributes(e.attributes).then((e=>{t.attributes=e}))),"number"==typeof e.indices&&r.push(this.loadAccessors(e.indices).then((e=>{t.indices=e}))),e.targets&&r.push(this.loadTargets(e.targets).then((e=>{t.targets=e}))),t.mode="number"==typeof e.mode?e.mode:4,"number"==typeof e.material?r.push(this.loadMaterial(e.material).then((e=>{t.material=e}))):r.push(this.loadDefaultMaterial().then((e=>{t.material=e}))),await Promise.all(r),t}makeIndexIterator(e){let t=0;const{offset:r,stride:n}=e;let s=1;return r&&(s+=r),n&&(s+=n),()=>(t+=3*s,e[t])}makeUnindexedIterator(e){const{offset:t,stride:r}=e;let n=1;t&&(n+=t),r&&(n+=r);let s=0;return()=>s+=3*n}computeTangent(e,t,r){const n=r?this.makeIndexIterator(r):this.makeUnindexedIterator(e),s=r?r.count:e.count,o=e.array,u=t.array,c=[];for(let e=0;e<s;e+=1){const e=n(),t=n(),r=n(),h=o.slice(3*e,3*e+3),d=o.slice(3*t,3*t+3),m=o.slice(3*r,3*r+3),p=u.slice(2*e,2*e+2),f=u.slice(2*t,2*t+2),g=u.slice(2*r,2*r+2),v=i(d,h),x=i(m,h),T=k(f,p),b=k(g,p),_=1/(T[0]*b[1]-b[0]*T[1]),E=Number.isFinite(_)?l(a(i(a(v,b[1]),a(x,T[1])),_)):[1,0,0];return c.push(...E,...E,...E),{itemSize:3,array:c,offset:0,normalized:!1,count:3*s}}return c}computeNormal(e,t){const r=[],n=e.array,s=t?t.count:e.count/3,o=t?this.makeIndexIterator(t):this.makeUnindexedIterator(e);for(let e=0;e<s;e+=1){let e=[0,0,0];const t=o(),s=o(),l=o(),u=[n[t],n[t+1],n[t+2]],c=[n[s],n[s+1],n[s+2]],h=[n[l],n[l+1],n[l+2]];i=e,a=z(O(u,c),O(h,c)),e=[i[0]+a[0],i[1]+a[1],i[2]+a[2]],r.push(...D(e)),r.push(...D(e)),r.push(...D(e))}var i,a;return{itemSize:3,array:r,offset:0,normalized:!1,count:s}}async loadMesh(e){const t=[],r=this.levelBlueprint.meshes[e],n={meshes:[]};return r.primitives?.forEach((e=>{t.push(this.loadPrimitive(e).then((e=>{e.attributes&&!e.attributes.normal&&(e.flatNormal=!0,e.attributes.normal=this.computeNormal(e.attributes.position,e.indices)),e.attributes&&!e.attributes.tangent&&e.attributes.uv&&e.flatNormal,n.meshes.push(e)})))})),n.weights=r.weights,n.name=r.name,await Promise.all(t),n}async loadNode(e){const t=[],r=this.levelBlueprint.nodes[e],n=new v(r,e);return n.children=[],r.children?.forEach((e=>{"number"==typeof e?t.push(this.loadNode(e).then((e=>{n.children.push(e),e.parent=n}))):t.push(this.loadRef(e).then((e=>{e.forEach((e=>{n.children.push(e),e.parent=n}))})))})),"number"==typeof r.mesh&&t.push(this.loadMesh(r.mesh).then((e=>{1===e.meshes.length?(n.mesh=e.meshes[0],n.weights=e.weights,n.name=e.name,this.level.meshes.set(n.uuid,n)):(e.meshes&&e.meshes.length>0&&!n.children&&(n.children=[]),e.meshes.forEach((t=>{const r=new v({mesh:t});r.weights=e.weights,n.weights=e.weights,n.children.push(r),r.parent=n,this.level.meshes.set(r.uuid,r)})))}))),"number"==typeof r.camera&&(n.camera=new x(this.loadCamera(r.camera)),n.camera.node=n,this.level.cameras.set(n.camera.uuid,n.camera),r.camera===this.levelBlueprint.camera&&(this.level.camera=n.camera)),"number"==typeof r.skin&&t.push(this.loadSkin(value).then((e=>{n.skin=e,this.level.skin.set(n.uuid,n)}))),await Promise.all(t),n}async loadScene(e){const t=this.levelBlueprint.scenes[e],r=[],n=new X({name:t.name,nodes:[]});return t.nodes&&t.nodes.forEach((e=>{r.push(this.loadNode(e).then((e=>{n.nodes.push(e),e.parent=n})))})),await Promise.all(r),n}loadAnimation(e){return new Promise((t=>{const r=this.levelBlueprint.animations[e],n={channels:[],samplers:[],maxTime:0},s=Object.entries(r),o=[];for(let t=0;t<s.length;t+=1){const[r,i]=s[t];switch(r){case"name":n.name=i;break;case"channels":for(let t=0;t<i.length;t+=1)o.push(this.loadChannel(e,t).then((e=>{n.channels.push(e)})));break;case"samplers":for(let t=0;t<i.length;t+=1)o.push(this.loadAnimationSampler(e,t).then((e=>{n.samplers.push(e),n.maxTime<e.input.max[0]&&(n.maxTime=e.input.max[0])})));break;default:console.error(`loadAnimations key ${r} not handled`)}}Promise.all([o]).then((()=>{t(n)}))}))}async loadAnimations(){const e=this.levelBlueprint.animations;if(!e)return null;{const t=[];for(let r=0;r<e.length;r+=1)t.push(this.loadAnimation(r).then((e=>{this.level.animations.set(e.id,e)})));await Promise.all(t)}}async loadSystem(e){let t=await this.loadRef(e.ref),r=new j({name:e.name,script:t});this.level.systems.set(r)}async loadSystems(){let e=[];return this.levelBlueprint.systems&&this.levelBlueprint.systems.forEach((t=>{e.push(this.loadSystem(t))})),await Promise.all(e)}async loadScripts(){let e=[];return this.levelBlueprint.scripts.forEach((t=>{let r=t.ref;e.push(this.loadRef(r).then((e=>{e?this.level.scripts.set(t.name,e):console.warn("script:"+t.name+" not found")})))})),await Promise.all(e)}async load(e,{filePath:t,sceneIndexOverride:r}={}){this.level=new G,this.levelBlueprint=e;const n=[];t&&(this.filePath=t),e.extensionsUsed&&console.table(e.extensionsUsed),e.extensionsRequired&&console.table(e.extensionsRequired);let s=0;return r?s=r:"number"==typeof e.scene&&(s=e.scene),n.push(this.loadScene(s).then((t=>{this.level.scene=t,this.level.camera.size>0&&("number"==typeof e.camera?this.level.camera=this.level.cameras[e.camera]:this.level.camera=this.level.cameras[0])}))),n.push(this.loadAnimations()),this.levelBlueprint.commands&&this.levelBlueprint.commands.forEach((e=>{let t=e.input;this.level.commands.set(t.controller+t.action+t.input??"",e.name)})),n.push(this.loadSystems()),this.levelBlueprint.scripts&&n.push(this.loadScripts()),await Promise.all(n),this.level}}function $(e,t,r){let n=r.temp;n.heroNode||(n.heroNode=t.findNode(t.scene.nodes,(e=>"heroGroup"===e.name)),n.speed=.55),n.platform||(n.platform=t.findNode(t.scene.nodes,(e=>{if(e.name)return"platformNode"===e.name}))),n.speed<10&&(n.speed+=1e-4);let s=n.heroNode;s.isTRS?(s.translation[2]-=n.speed,s.updateMatrixFromTRS()):s.matrix[14]-=n.speed,n.platform.matrix[14]-=n.speed}function H(e,t,r){let n=r.temp;if(n.enemyPull||(n.enemyPull=t.findAllNodes(t.scene.nodes,(e=>{if(e.name)return e.name.startsWith("enemy")}))),n.hero||(n.hero=t.findNode(t.scene.nodes,(e=>{if(e.name)return"hero"===e.name})),n.score=0,n.updateScore=!0),!n.scoreElement){let e=document.querySelector(".game-score");n.scoreElement=e}if(!n.bestScoreElement){let e=document.querySelector(".best-game-score");n.bestScoreElement=e}let s=n.enemyPull,o=n.hero.matrixWorld;for(let t=0;t<s.length;t++){const r=s[t].matrixWorld;let l=[r[12],r[13],r[14]];if(i=[o[12],o[13],o[14]],a=l,Math.sqrt(function(e,t){const r=e[0]-t[0],n=e[1]-t[1],s=e[2]-t[2];return r*r+n*n+s*s}(i,a))<=1.7){+n.bestScoreElement.textContent<n.score&&(n.bestScoreElement.textContent=n.score),e.getEngine().restart();break}n.heroNode.matrix[14]<r[14]&&(n.updateScore=!0,n.score+=1,s[t].matrix[14]-=90,s[t].matrix[12]=36*Math.random()-18)}var i,a;t.camera.info.yfov<1.6&&(t.camera.info.yfov+=1e-4),n.updateScore&&n.scoreElement&&(n.scoreElement.textContent=n.score)}function q(e,t,r){let n=r.temp;if(n.heroNode||(n.heroNode=t.findNode(t.scene.nodes,(e=>(console.log(e.name),"heroGroup"===e.name)))),n.moveRight){let e=t.camera.node.parent;e.matrix[12]<18&&(e.isTRS?(e.translation[0]+=.3,e.updateMatrixFromTRS()):e.matrix[12]+=.3)}if(n.moveLeft){let e=t.camera.node.parent;e.matrix[12]>-18&&(e.isTRS?(e.translation[0]-=.3,e.updateMatrixFromTRS()):e.matrix[12]-=.3)}}class Y{files;constructor(){this.files={}}setFileContent(e,t){this.files[e].content=t}async downloadRootFile(e){let t=await this._fetchFile({id:e,name:e+".json"});this.files=t.reduce(((e,t)=>(e[t.id]=t,e)),{})}async downloadGameFile(){let e=this.getFileByPath("/game.json");return await this.downloadFile(e),JSON.parse(JSON.stringify(e.content))}async downloadLevelFile(e){let t=this.getFileByPath("/levels/"+e+".json");return await this.downloadFile(t),JSON.parse(JSON.stringify(t.content))}async downloadAllFiles(){this.files.values((e=>{this.downloadFile(e)}))}async downloadFile(e){if(e.content)return e.content;const t=await this._fetchFile(e);return this.setFileContent(e.id,t),e}async _fetchFile(e){let t=e.name.match(/[^\.]+$/)[0].toLowerCase(),r="./gameFiles/"+e.id+"."+t,n=await fetch(r,{headers:{"Content-Type":e.mimeType}});if("gltf"===t||"json"===t)n=await n.json();else if("bin"===t)n=await n.arrayBuffer();else if("jpg"===t||"png"===t){let e=await n.arrayBuffer();const t=new DataView(e);n=new Blob([t],{type:"image/png"})}return n}getFileByPath(e){return Object.values(this.files).find((t=>t.path===e))}async loadRef(e){if("common"===e.type)return r[e.uri]?r[e.uri]:t[e.uri];{const t=this.getFileByPath(e.uri);t||console.error("No file for the ref",e.uri);let r=e.uri.match(/[^\.]+$/)[0].toLowerCase(),n=e.uri.substring(0,e.uri.lastIndexOf("/"));if(!t.content){let e=await this.downloadFile(t);t.content=await e.content}if("gltf"===r){let e=JSON.parse(JSON.stringify(t.content));return(await new W(this).load(e,{filePath:n})).scene.nodes}return t.content}}}class J{update;render;logger;paused;idRequestAnimationFrame;currentUpdate;framerate;speed;constructor({update:e,render:t,logger:r,framerate:n=60,speed:s=1}={}){this.update=e,this.render=t,this.logger=r,this.elapsedTime=0,this.lastUpdate=null,this.paused=!1,this.idRequestAnimationFrame=null,this.currentUpdate=0,this.framerate=n,this.speed=s}mainLoop(e){if(this.lastUpdate&&!1===this.paused)for(this.currentUpdate=e,this.elapsedTime+=this.currentUpdate-this.lastUpdate;this.elapsedTime>=1e3/this.framerate/this.speed&&!1===this.paused;){if(this.elapsedTime>=5e3){this.logger.log("droped"+this.elapsedTime),this.elapsedTime-=this.elapsedTime,this.update(this.elapsedTime);continue}this.elapsedTime-=1e3/this.framerate/this.speed;let e=1e3/this.framerate;this.update(e),this.render(e)}this.paused||(this.idRequestAnimationFrame=window.requestAnimationFrame(this.mainLoop.bind(this))),this.lastUpdate=e}pause(){this.paused=!0}play(){this.paused=!1,this.mainLoop()}setUpdate(e){this.update=e}setRender(e){this.render=e}tick(e=1){this.idRequestAnimationFrame=window.requestAnimationFrame((()=>{for(;e--;){let e=1e3/this.framerate;this.update(e),this.render(e)}}))}destroy(){console.log("Loop cancelAnimationFrame"),window.cancelAnimationFrame(this.idRequestAnimationFrame),this.paused=!0}}class Z{constructor(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext)}playAudio=function(e,t,r){const n=new XMLHttpRequest;n.open("GET",e.src),n.responseType="arraybuffer";const s=this.audioCtx.createBufferSource();return n.addEventListener("load",(()=>{this.audioCtx.decodeAudioData(n.response).then((e=>{s.buffer=e,s.loop=t,s.connect(this.audioCtx.destination),s.start()}))})),n.send(),s};destroy=function(){this.audioCtx&&this.audioCtx.close()};update(e){for(let t=0;t<e.length;t++){let t=e.pop();this.playAudio(t,t.loop,t.volume)}}}const Q=window;var K;function ee(e){Q.console&&(Q.console.error?Q.console.error(e):Q.console.log&&Q.console.log(e))}function te(e,t,r,n){const s=n||ee,o=e.createShader(r);return e.shaderSource(o,t),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)?o:(s(`*** Error compiling shader '${o}':${e.getShaderInfoLog(o)}\n${t.split("\n").map(((e,t)=>`${t+1}: ${e}`)).join("\n")}`),e.deleteShader(o),null)}(K=K||Q)===K.top&&(console.log("%c%s","color:blue;font-weight:bold;","for more about webgl-utils.js see:"),console.log("%c%s","color:blue;font-weight:bold;","https://webglfundamentals.org/webgl/lessons/webgl-boilerplate.html"));const re=["VERTEX_SHADER","FRAGMENT_SHADER"];function ne(e,t){return t===e.SAMPLER_2D?e.TEXTURE_2D:t===e.SAMPLER_CUBE?e.TEXTURE_CUBE_MAP:void 0}function se(e,...t){e=e.uniformSetters||e;for(const r of t)Object.keys(r).forEach((t=>{const n=e[t];n&&n(r[t])}))}function oe(e,t,r,n,s){const o=function(e,t,r,n,s){const o=[];for(let r=0;r<t.length;++r)o.push(te(e,t[r],e[re[r]],s));return function(e,t,r,n,s){const o=s||ee,i=e.createProgram();return t.forEach((t=>{e.attachShader(i,t)})),r&&r.forEach(((t,r)=>{e.bindAttribLocation(i,n?n[r]:r,t)})),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)?i:(o(`Error in program linking:${e.getProgramInfoLog(i)}`),e.deleteProgram(i),null)}(e,o,r,n,s)}(e,t=t.map((e=>{const t=document.getElementById(e);return t?t.text:e})),r,n,s);if(!o)return null;const i=function(e,t){let r=0;function n(t,n){const s=e.getUniformLocation(t,n.name),{type:o}=n,i=n.size>1&&"[0]"===n.name.substr(-3);if(o===e.FLOAT&&i)return function(t){e.uniform1fv(s,t)};if(o===e.FLOAT)return function(t){e.uniform1f(s,t)};if(o===e.FLOAT_VEC2)return function(t){e.uniform2fv(s,t)};if(o===e.FLOAT_VEC3)return function(t){e.uniform3fv(s,t)};if(o===e.FLOAT_VEC4)return function(t){e.uniform4fv(s,t)};if(o===e.INT&&i)return function(t){e.uniform1iv(s,t)};if(o===e.INT)return function(t){e.uniform1i(s,t)};if(o===e.INT_VEC2)return function(t){e.uniform2iv(s,t)};if(o===e.INT_VEC3)return function(t){e.uniform3iv(s,t)};if(o===e.INT_VEC4)return function(t){e.uniform4iv(s,t)};if(o===e.BOOL)return function(t){e.uniform1iv(s,t)};if(o===e.BOOL_VEC2)return function(t){e.uniform2iv(s,t)};if(o===e.BOOL_VEC3)return function(t){e.uniform3iv(s,t)};if(o===e.BOOL_VEC4)return function(t){e.uniform4iv(s,t)};if(o===e.FLOAT_MAT2)return function(t){e.uniformMatrix2fv(s,!1,t)};if(o===e.FLOAT_MAT3)return function(t){e.uniformMatrix3fv(s,!1,t)};if(o===e.FLOAT_MAT4)return function(t){e.uniformMatrix4fv(s,!1,t)};if((o===e.SAMPLER_2D||o===e.SAMPLER_CUBE)&&i){const t=[];for(let e=0;e<info.size;++e)t.push(r++);return function(t,r){return function(n){e.uniform1iv(s,r),n.forEach(((n,s)=>{e.activeTexture(e.TEXTURE0+r[s]),e.bindTexture(t,n)}))}}(ne(e,o),t)}if(o===e.SAMPLER_2D||o===e.SAMPLER_CUBE)return a=ne(e,o),l=r++,function(t){e.uniform1i(s,l),e.activeTexture(e.TEXTURE0+l),e.bindTexture(a,t)};var a,l;throw`unknown type: 0x${o.toString(16)}`}const s={},o=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let r=0;r<o;++r){const o=e.getActiveUniform(t,r);if(!o)break;let{name:i}=o;"[0]"===i.substr(-3)&&(i=i.substr(0,i.length-3));const a=n(t,o);s[i]=a}return s}(e,o),a=function(e,t){const r={};function n(t){return function(r){if(r.value)switch(e.disableVertexAttribArray(t),r.value.length){case 4:e.vertexAttrib4fv(t,r.value);break;case 3:e.vertexAttrib3fv(t,r.value);break;case 2:e.vertexAttrib2fv(t,r.value);break;case 1:e.vertexAttrib1fv(t,r.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else e.bindBuffer(e.ARRAY_BUFFER,r.buffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,r.numComponents||r.size,r.type||e.FLOAT,r.normalize||!1,r.stride||0,r.offset||0)}}const s=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let o=0;o<s;++o){const s=e.getActiveAttrib(t,o);if(!s)break;const i=e.getAttribLocation(t,s.name);r[s.name]=n(i)}return r}(e,o);return{program:o,uniformSetters:i,attribSetters:a}}function ie(e,t,r){(function(e,t){e=e.attribSetters||e,Object.keys(t).forEach((r=>{const n=e[r];n&&n(t[r])}))})(t,r.attribs),r.indices&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.indices)}function ae(e,t,r,n){r=r||e.ARRAY_BUFFER;const s=e.createBuffer();return e.bindBuffer(r,s),e.bufferData(r,t,n||e.STATIC_DRAW),s}function le(e){return"indices"!==e}function ue(e,t){if(t instanceof Int8Array)return e.BYTE;if(t instanceof Uint8Array)return e.UNSIGNED_BYTE;if(t instanceof Int16Array)return e.SHORT;if(t instanceof Uint16Array)return e.UNSIGNED_SHORT;if(t instanceof Int32Array)return e.INT;if(t instanceof Uint32Array)return e.UNSIGNED_INT;if(t instanceof Float32Array)return e.FLOAT;throw"unsupported typed array type"}function ce(e){return e.buffer&&e.buffer instanceof ArrayBuffer}function he(e,t){if(ce(e))return e;if(e.data&&ce(e.data))return e.data;Array.isArray(e)&&(e={data:e}),e.numComponents||(e.numComponents=ge(t,e.length));let{type:r}=e;r||"indices"===t&&(r=Uint16Array);const n=(s=e.numComponents,o=e.data.length/e.numComponents|0,function(e,t){let r=0;return e.push=function(){for(let t=0;t<arguments.length;++t){const n=arguments[t];if(n instanceof Array||n.buffer&&n.buffer instanceof ArrayBuffer)for(let t=0;t<n.length;++t)e[r++]=n[t];else e[r++]=n}},e.reset=function(e){r=e||0},e.numComponents=t,Object.defineProperty(e,"numElements",{get(){return this.length/this.numComponents|0}}),e}(new(r||Float32Array)(s*o),s));var s,o;return n.push(e.data),n}function de(e,t,r){const n=r||function(e){const t={};return Object.keys(e).filter(le).forEach((e=>{t[`a_${e}`]=e})),t}(t),s={};return Object.keys(n).forEach((r=>{const o=n[r],i=t[o];if(i.value)s[r]={value:i.value};else{const t=he(i,o);s[r]={buffer:ae(e,t),numComponents:i.numComponents||t.numComponents||ge(o),type:ue(e,t),normalize:(a=t,a instanceof Int8Array||a instanceof Uint8Array),stride:i.stride||0,offset:i.offset||0}}var a})),s}function me(e){return e.length?e:e.data}const pe=/coord|texture/i,fe=/color|colour/i;function ge(e,t){let r;if(r=pe.test(e)?2:fe.test(e)?4:3,t%r>0)throw new Error(`Can not guess numComponents for attribute '${e}'. Tried ${r} but ${t} values is not evenly divisible by ${r}. You should specify it.`);return r}const ve=["position","positions","a_position"];function xe(e,t,r){const n={attribs:de(e,t,r)};let{indices:s}=t;return s?(s=he(s,"indices"),n.indices=ae(e,s,e.ELEMENT_ARRAY_BUFFER),n.numElements=s.length):n.numElements=function(e){let t;for(const r of ve)if(r in e){t=r;break}t=t||Object.keys(e)[0];const r=e[t],{length:n}=me(r),s=function(e,t){return e.numComponents||e.size||ge(t,me(e).length)}(r,t),o=n/s;if(n%s>0)throw new Error(`numComponents ${s} not correct for length ${n}`);return o}(t),n}var Te;!document.documentMode&&window.StyleMedia&&(HTMLCanvasElement.prototype.getContext=(Te=HTMLCanvasElement.prototype.getContext,function(){let e=arguments;const t=e[0];return"webgl"===t&&(e=[].slice.call(arguments),e[0]="experimental-webgl"),Te.apply(this,e)}));const be=["float D_GGX(float NoH, float roughness ) {\n    float a2 = roughness  * roughness ;\n    float f = (NoH * a2 - NoH) * NoH + 1.0;\n    return a2 / (PI * f * f);\n}","vec3 F_Schlick(float u, vec3 f0) {\n    return f0 + (vec3(1.0) - f0) * pow(1.0 - u, 5.0);\n}","float V_SmithGGXCorrelated(float NoV, float NoL, float a) {\n    float a2 = a * a;\n    float GGXL = NoV * sqrt((-NoL * a2 + NoL) * NoL + a2);\n    float GGXV = NoL * sqrt((-NoV * a2 + NoV) * NoV + a2);\n    return 0.5 / (GGXV + GGXL);\n}","vec3 specular_brdf(float D_GGX_value,float V_SmithGGXCorrelated_value,vec3 F_Schlick_value) {\n  return (D_GGX_value * V_SmithGGXCorrelated_value) * F_Schlick_value;\n}","vec3 diffuse_brdf(vec3 diffuseColor_value) {\n  return (1.0/PI)* diffuseColor_value;\n}"],_e="float",Ee="mat4",ye="vec2",we="vec3",Ce="vec4",Me="sampler2D",Re=function(e,t){return`attribute ${e} ${t};`},Se=function(e,t){return`uniform ${e} ${t};`},Ae=function(e,t){return`varying ${e} ${t};`},Pe=function(e,t,r,n,s,o,i,a){const l=[...e,...t,...r,...n,...s].join("\n"),u=function(e){return`\nvoid main() {\n${e.join("\n")}\n}`}([...o,...i,...a]);return l+u};class Ie{constructor(){this.flatNormal=!1,this.useVextexColor=!1,this.nbTexture=0,this.useIndices=!1,this.useTangent=!1,this.isMorphed=!1,this.nbMorphTargetPosition=0,this.nbMorphTargetNormal=0,this.nbMorphTargetTangent=0,this.nbMorphWeight=0,this.isSkinned=!1,this.nbJoint=0,this.nbUv=0,this.envMap=!1}}class Le{constructor(){this.getMetallicRoughnessTexture=!1,this.metallicRoughnessTextureCoord=0,this.getBaseColorTexture=!1,this.baseColorTextureCoord=0,this.getOcclusionTexture=!1,this.occlusionTextureCoord=0,this.getNormalTexture=!1,this.normalTextureCoord=0,this.getEmissiveTexture=!1,this.emissiveTextureCoord=0,this.doubleSided=!1,this.useAlphaTest=!1}}const Ne=e.p+"1c13032ee8193b84256d56f2c9b74522.jpg",Ue=e.p+"2585632368ab7254a4adf167c4e9d91b.jpg",Be=e.p+"95b0e12ab1ed4a2240c84cc6bd7b55c0.jpg",Fe={posX:Ne,negX:e.p+"b88a0f336990d7afdcad12c98b7e6ad1.jpg",posY:Ue,negY:e.p+"5bdd574a7313c9f889a33caaa4ff39c0.jpg",posZ:Be,negZ:e.p+"6e67d25d9b302f00b7a80631b2754514.jpg"},ke={u_lightWorldPos:[0,-10,0],u_viewInverse:c(),u_lightColor:[1,1,1,1]};class De{constructor(e){this.gl=e,this.viewport=[0,0,e.canvas.width,e.canvas.heigh],this.frontFace=e.CCW,this.glStatus={[e.DEPTH_TEST]:!0,[e.CULL_FACE]:!0,[e.BLEND]:!1,[e.blendFunc]:null},this.quadBufferInfo=this.createXYQuadBufferInfo(),this.currentProgram=null,this.programsInfo={},this.nodesProgramInfo={},this.currentBufferInfo=null,this.bufferMeshDico={},this.texturesDico={},this.defaulTexture=null,this.defaultMaterialPBR=null,this.extensions={}}enableProperty(e){this.gl.enable(e),this.glStatus[e]=!0}disableProperty(e){this.gl.disable(e),this.glStatus[e]=!1}getProgramRef(e){return this.nodesProgramInfo[e.uuid]||(this.nodesProgramInfo[e.uuid]={programId:null,needUpdate:!0}),this.nodesProgramInfo[e.uuid]}generateStringFromObject(e){let t="";return Object.values(e).forEach((e=>{"number"==typeof e?t+=e.toString():"boolean"==typeof e&&(t+=e?"1":"0")})),t}generateProgramID(e,t){let r="";return r=this.generateStringFromObject(e)+this.generateStringFromObject(t),r}generatePickingProgram(){const e="attribute vec4 a_position;\n\nuniform mat4 u_world;\nuniform mat4 u_worldViewProjection;\n\nvoid main() {\n  // Multiply the position by the matrix.\n\n  gl_Position = u_worldViewProjection* u_world * a_position;\n}",t="precision mediump float;\n\n  uniform vec4 u_id;\n\n  void main() {\n     gl_FragColor = u_id;\n  }";return console.log(e),console.log(t),this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("OES_standard_derivatives"),this.gl.getExtension("WEBGL_draw_buffers"),this.gl.getExtension("WEBGL_color_buffer_float"),oe(this.gl,[e,t])}updateProgramPicking(){if(!this.programsInfo.picking){const e=this.generatePickingProgram.call(this);this.programsInfo.picking=e}return this.currentProgram!==this.programsInfo.picking&&(this.gl.useProgram(this.programsInfo.picking.program),this.currentProgram=this.programsInfo.picking),this.programsInfo.picking}generateCubeMapProgram(){const e="\nattribute vec4 a_position;\nvarying vec4 v_position;\nvoid main() {\n  v_position = a_position;\n  gl_Position = vec4(a_position.xy, 1, 1);\n}",t="\nprecision mediump float;\n\nuniform samplerCube u_cubeMap;\nuniform mat4 u_viewDirectionProjectionInverse;\n\nvarying vec4 v_position;\nvoid main() {\n  \n  vec4 t = u_viewDirectionProjectionInverse * v_position;\n  gl_FragColor = textureCube(u_cubeMap, normalize(t.xyz / t.w));\n  \n  float fogAmount = smoothstep(0.99999999, 1.0, gl_FragCoord.z);\n  gl_FragColor = mix(gl_FragColor, vec4(0.0), fogAmount);\n}";return console.log(e),console.log(t),oe(this.gl,[e,t])}updateProgramCubeMap(){if(!this.programsInfo.cubeMap){const e=this.generateCubeMapProgram();this.programsInfo.cubeMap=e}return this.currentProgram!==this.programsInfo.cubeMap&&(this.gl.useProgram(this.programsInfo.cubeMap.program),this.currentProgram=this.programsInfo.cubeMap),this.programsInfo.cubeMap}generateProgram(e,t){const r=function(e,t){const r=[],n=[Se(Ee,"u_viewInverse"),Se(Ee,"u_worldViewProjection"),Se(Ee,"u_world"),Se(Ee,"u_matrix"),Se(we,"u_lightWorldPos"),Se(Ee,"u_worldInverseTranspose"),Se(we,"u_worldCameraPosition")],s=[Re(Ce,"a_position"),Re(we,"a_normal")],o=[Ae(Ce,"v_position"),Ae(we,"v_normal"),Ae(we,"v_surfaceToLight"),Ae(we,"v_surfaceToView")];let i=["v_position = a_position;","v_normal =a_normal;","mat4 world = u_world ;"];const a=["v_normal = (u_worldInverseTranspose * vec4(v_normal, 0)).xyz;","vec3 surfaceWorldPosition = (world * v_position).xyz;","v_surfaceToLight = u_lightWorldPos - surfaceWorldPosition;","v_surfaceToView = vec3(u_worldCameraPosition)  - surfaceWorldPosition;",("v_position","gl_Position=v_position;")];for(let t=0;t<e.nbUv;t+=1){const e=Re(ye,`a_texCoord${t}`);s.push(e);const r=Ae(ye,`v_texCoord${t}`);o.push(r);const n=[`v_texCoord${t}  = a_texCoord${t};`];i=[...i,...n]}if(e.useVextexColor){const e=Re(Ce,"a_color");s.push(e);const t=Ae(Ce,"v_color");o.push(t);const r=["v_color = a_color;"];i=[...i,...r]}if(e.useTangent){const e=Re(Ce,"a_tangent");s.push(e);const t=Ae(we,"v_tangent");o.push(t);const r=Ae(Ce,"v_bitangent");o.push(r);const n=["v_tangent = vec3( a_tangent.xyz );","v_bitangent = vec4(cross(v_normal.xyz, a_tangent.xyz),a_tangent.w);"];i=[...i,...n]}if(e.isMorphed){const t=Se(_e,`u_morphWeights[${e.morphWeight}]`);if(n.push(t),e.nbMorphTargetPosition>0){const t=[];for(let r=0;r<e.nbMorphTargetPosition;r+=1){const e=Re(we,`a_morphTargetsPosition_${r}`);s.push(e),t.push(`v_position += v_position + u_morphWeights[${r}] * vec4(a_morphTargetsPosition_${r}.xyz,0.0 );`)}i=[...i,...t]}if(e.nbMorphTargetNormal>0){const t=[];for(let r=0;r<e.nbMorphTargetNormal;r+=1){const e=Re(we,`a_morphTargetsNormal_${r}`);s.push(e),t.push(`v_position += v_position + u_morphWeights[${r}] * vec4(a_morphTargetsNormal_${r}.xyz,0.0 );`)}i=[...i,...t]}if(e.nbMorphTargetTangent>0&&e.useTangent){const t=[];for(let r=0;r<e.nbMorphTargetTangent;r+=1){const e=Re(we,`a_morphTargetsTangent_${r}`);s.push(e),t.push(`v_position += v_position + u_morphWeights[${r}] * vec4(a_morphTargetsTangent_${r}.xyz,0.0 );`)}i=[...i,...t]}}if(e.isSkinned){const t=`#define JOINT_COUNT ${e.nbJoint};`;r.push(t);const o=Se(Ee,`u_jointMatrix[${e.nbJoint}]`);n.push(o);const a=Re(Ce,"a_joint");s.push(a);const l=Re(Ce,"a_weight");s.push(l);const u=["mat4 skinMatrix = mat4(0.0);","skinMatrix += a_weight.x * u_jointMatrix[int(a_joint.x)];","skinMatrix += a_weight.y * u_jointMatrix[int(a_joint.y)];","skinMatrix += a_weight.z * u_jointMatrix[int(a_joint.z)];","skinMatrix += a_weight.w * u_jointMatrix[int(a_joint.w)];","world = world * skinMatrix;","v_normal = vec4( skinMatrix * vec4( v_normal, 0.0 ) ).xyz;"];i=[...i,...u]}return Pe(r,n,s,o,[],i,["v_position = u_worldViewProjection * world *v_position;"],a)}(e),n=function(e,t){const r=["precision mediump float;",Se(Ce,"u_lightColor"),Se(Ce,"u_baseColorFactor"),Se(_e,"u_alpha"),Se(_e,"u_metallic"),Se(_e,"u_roughness")],n=[Ae(Ce,"v_position"),Ae(we,"v_normal"),Ae(we,"v_surfaceToLight"),Ae(we,"v_surfaceToView")],s=[...be];let o=["float fogAmount = smoothstep(0.9999, 1.0, gl_FragCoord.z);","baseColor = mix(baseColor, vec4(0.0), fogAmount);","float alpha = baseColor.a;","vec3 a_normal = normalize(v_normal);","vec3 surfaceToLight = normalize(v_surfaceToLight);","vec3 surfaceToView = normalize(v_surfaceToView);","vec3 halfVector = normalize(surfaceToView + surfaceToLight);","float metallic = u_metallic;","float perceptualRoughness = u_roughness;"],i=["vec3 f0 = (1.0 - metallic) * baseColor.rgb;","perceptualRoughness += 0.01;","float reflectance = 0.04;","float NoV = abs(dot(a_normal, surfaceToView)) + 1e-5;","float NoL = clamp(dot(a_normal, surfaceToLight), 0.1, 1.0);","float NoH = clamp(dot(a_normal, halfVector), 0.0, 1.0);","float LoH = clamp(dot(surfaceToLight, halfVector), 0.0, 1.0);","float roughness = perceptualRoughness * perceptualRoughness;","float D = D_GGX(NoH, roughness);","vec3  F = F_Schlick(LoH, f0);","float V = V_SmithGGXCorrelated(NoV, NoL, roughness);","vec3 specularBrdfColor = specular_brdf(D ,V, F);","vec3 diffuseBrdfColor = diffuse_brdf( baseColor.rgb);","float energyCompensation = 1.0;","vec4 outColor =vec4( (vec3(u_lightColor) * (diffuseBrdfColor + specularBrdfColor)), 1.0);"];const a=[("outColor","gl_FragColor=outColor;")];for(let t=0;t<e.nbUv;t+=1){const e=Ae(ye,`v_texCoord${t}`);n.push(e)}if(e.useVextexColor){const e=Ae(Ce,"v_color");n.push(e);const t=["baseColor = baseColor * vec4(v_color.rgb,1);"];o=[...o,...t]}if(t.getBaseColorTexture){const e=Se(Me,"u_baseColorTexture");r.push(e),o=[`vec4 baseColor = texture2D(u_baseColorTexture,v_texCoord${t.baseColorTextureCoord}) * u_baseColorFactor;`,...o]}else o=["vec4 baseColor = u_baseColorFactor;",...o];if(e.useTangent){const e=Ae(we,"v_tangent");n.push(e);const r=Ae(Ce,"v_bitangent");n.push(r);let s=[];s=t.doubleSided?["vec3 tangent = v_tangent *faceDirection;","vec4 bitangent = v_bitangent *faceDirection;"]:["vec3 tangent = v_tangent;","vec4 bitangent = v_bitangent;"];const i=["mat3 tbn = mat3(tangent, bitangent, a_normal);","a_normal = normalize(tbn * a_normal);"];o=[...o,...s,...i]}if(t.getEmissiveTexture){const e=Se(Me,"u_emissiveTexture");r.push(e);const n=Se(we,"u_emissiveFactor");r.push(n);const s=[`vec3 emissive = texture2D(u_emissiveTexture, v_texCoord${t.emissiveTextureCoord}).rgb * u_emissiveFactor;`,"outColor.rgb += emissive;"];i=[...i,...s]}else{const e=Se(we,"u_emissiveFactor");r.push(e);const t=["vec3 emissive = u_emissiveFactor;","outColor.rgb += emissive;"];i=[...i,...t]}if(t.getNormalTexture){const e=Se(Me,"u_normalTexture");r.push(e);const n=[`a_normal = texture2D(u_normalTexture, v_texCoord${t.normalTextureCoord}).rgb * a_normal;`];o=[...o,...n]}if(t.getMetallicRoughnessTexture){const e=Se(Me,"u_metallicRoughnessTexture");r.push(e);const n=[`vec4 rougnessMetallicSample = texture2D(u_metallicRoughnessTexture, v_texCoord${t.metallicRoughnessTextureCoord});`,"perceptualRoughness = rougnessMetallicSample.g * perceptualRoughness;","metallic = rougnessMetallicSample.b * metallic;"];o=[...o,...n]}if(t.getOcclusionTexture){const e=Se(Me,"u_occlusionTexture");r.push(e)}return e.envMap,Pe(["#define PI 3.1415926535897932384626433832795"],r,[],n,s,o,i,a)}(e,t);return console.log(r),console.log(n),this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("OES_standard_derivatives"),oe(this.gl,[r,n])}updateProgram(e,t,r){const n=this.generateProgramID(t,r);if(e.programId=n,!this.programsInfo[n]){const e=this.generateProgram(t,r);this.programsInfo[n]=e}return e.needUpdate=!1,this.programsInfo[n]}loadProgram(e){return e.programId&&this.currentProgram!==this.programsInfo[e.programId]&&(this.gl.useProgram(this.programsInfo[e.programId].program),this.currentProgram=this.programsInfo[e.programId]),this.currentProgram}createCubeMapTexture(){let e=this.texturesDico.cubeMap;return e||(e=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,e),[{target:this.gl.TEXTURE_CUBE_MAP_POSITIVE_X,url:Fe.posX},{target:this.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,url:Fe.negX},{target:this.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,url:Fe.posY},{target:this.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,url:Fe.negY},{target:this.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,url:Fe.posZ},{target:this.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,url:Fe.negZ}].forEach((t=>{const{target:r,url:n}=t,s=this.gl.RGBA,o=this.gl.RGBA,i=this.gl.UNSIGNED_BYTE;this.gl.texImage2D(r,0,s,512,512,0,o,i,null);const a=new Image;a.src=n,a.addEventListener("load",(()=>{this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,e),this.gl.texImage2D(r,0,s,o,i,a),this.gl.generateMipmap(this.gl.TEXTURE_CUBE_MAP)}))})),this.gl.generateMipmap(this.gl.TEXTURE_CUBE_MAP),this.gl.texParameteri(this.gl.TEXTURE_CUBE_MAP,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.texturesDico.cubeMap=e),e}createTexture(e){if(this.texturesDico[e.uuid])return this.texturesDico[e.uuid];const{gl:t}=this,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.image),this.isPowerOf2(e.image.width)&&this.isPowerOf2(e.image.height)?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.wrapT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e.magFilter),t.generateMipmap(t.TEXTURE_2D)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),this.texturesDico[e.uuid]=r,r}getDefaultMrTexture(e=1){const{gl:t}=this;return this.defaultMaterialPBR||(this.defaultMaterialPBR=t.createTexture(),t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this.defaultMaterialPBR),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([255,255,255,255]))),this.defaultMaterialPBR}createDefaultTexture(e=0){const{gl:t}=this;return this.defaulTexture||(this.defaulTexture=t.createTexture(),t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this.defaulTexture),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([255,255,255,255]))),this.defaulTexture}getDefaultTexture(e){return this.defaulTexture||(this.defaulTexture=this.createDefaultTexture(e)),this.defaulTexture}isPowerOf2(e){return 0==(e&e-1)}getGeometryProgramNeed(e,t){const r=new Ie;if(t.flatNormal?r.flatNormal=!0:r.flatNormal=!1,t.attributes.tangent?r.useTangent=!0:r.useTangent=!1,t.attributes.color?r.useVextexColor=!0:r.useVextexColor=!1,t.indices?r.useIndices=!0:r.useIndices=!1,t.targets){const{weights:n}=e;let s=0,o=0;const i=0;r.isMorphed=!0,r.morphWeight=e.weights.length,t.targets.forEach((e=>{e.position&&s++,e.normale&&o++,e.tangent})),r.nbMorphTargetPosition=s,r.nbMorphTargetNormal=o,r.nbMorphTargetTangent=i}else r.isMorphed=!1;return e.skin&&(r.isSkinned=!0,r.nbJoint=e.skin.jointMatrices.length),t.attributes.uv&&(r.nbUv+=1),t.attributes.uv2&&(r.nbUv+=1),r}getMaterialProgramNeed(e,t){const r=new Le,{material:n}=t,{normalTexture:s,occlusionTexture:o,emissiveTexture:i,alphaMode:a,alphaCutoff:l}=n,{baseColorTexture:u,metallicRoughnessTexture:c}=n.metallicRoughness;return u&&(r.getBaseColorTexture=!0,r.baseColorTextureCoord=u.texCoord),c&&(r.getMetallicRoughnessTexture=!0,r.metallicRoughnessTextureCoord=c.texCoord),i&&(r.getEmissiveTexture=!0,r.emissiveTextureCoord=i.texCoord),s&&(r.getNormalTexture=!0,r.normalTextureCoord=s.texCoord),o&&(r.getOcclusionTexture=!0,r.occlusionTextureCoord=o.texCoord),n.doubleSided&&(r.doubleSided=!0),r}setGeometryBuffer(e,t,r,n,o){d(t.viewMatrix)<0?this.gl.frontFace(2305):this.gl.frontFace(2304);let i=t.matrixWorld;t.skin&&t.skin.skeleton&&(i=t.skin.skeleton.matrixWorld);const a=(l=m(i),(u=u||new s(16))[0]=l[0],u[1]=l[4],u[2]=l[8],u[3]=l[12],u[4]=l[1],u[5]=l[5],u[6]=l[9],u[7]=l[13],u[8]=l[2],u[9]=l[6],u[10]=l[10],u[11]=l[14],u[12]=l[3],u[13]=l[7],u[14]=l[11],u[15]=l[15],u);var l,u;const c={u_world:i,u_worldViewProjection:n.viewProjectionMatrix,u_worldInverseTranspose:a,u_worldCameraPosition:n.worldPosition};o&&(c.u_id=[(o>>0&255)/255,(o>>8&255)/255,(o>>16&255)/255,(o>>24&255)/255]);{const e=this.createCubeMapTexture();c.cubeMap=e}const h={position:{numComponents:r.attributes.position.itemSize,offset:r.attributes.position.offset,normalize:r.attributes.position.normalized,data:r.attributes.position.array},normal:{numComponents:r.attributes.normal.itemSize,offset:r.attributes.normal.offset,normalize:r.attributes.normal.normalized,data:r.attributes.normal.array}};if(r.attributes.tangent&&(h.tangent={numComponents:r.attributes.tangent.itemSize,offset:r.attributes.tangent.offset,data:r.attributes.tangent.array,normalize:r.attributes.tangent.normalized}),r.attributes.color&&(h.color={numComponents:r.attributes.color.itemSize,offset:r.attributes.color.offset,normalize:r.attributes.color.normalized,data:r.attributes.color.array}),r.indices&&(h.indices={numComponents:r.indices.itemSize,offset:r.indices.offset,normalize:r.indices.normalized,data:r.indices.array}),r.targets){const{weights:e}=t;c.u_morphWeights=e;let n=0,s=0,o=0;r.targets.forEach((e=>{e.position&&(h[`morphTargetsPosition_${n}`]={numComponents:e.position.itemSize,offset:e.position.offset,data:e.position.array},n+=1),e.normal&&(h[`morphTargetsNormal_${s}`]={numComponents:e.normal.itemSize,offset:e.normal.offset,data:e.normal.array},s+=1),e.tangent&&(h[`morphTargetsTangent_${o}`]={numComponents:e.tangent.itemSize,offset:e.tangent.offset,data:e.tangent.array},o+=1)}))}return t.skin&&(c.u_jointMatrix=t.skin.boneArray,h.weight={numComponents:r.attributes.skinWeight.itemSize,offset:r.attributes.skinWeight.offset,data:r.attributes.skinWeight.array},h.joint={numComponents:r.attributes.skinIndex.itemSize,offset:r.attributes.skinIndex.offset,data:r.attributes.skinIndex.array}),r.indices&&r.indices.stride&&(h.indices.stride=r.indices.stride),r.attributes.position&&r.attributes.position.stride&&(h.position.stride=r.attributes.position.stride),r.attributes.normal&&r.attributes.normal.stride&&(h.normal.stride=r.attributes.normal.stride),r.attributes.uv&&(h.texCoord0={numComponents:r.attributes.uv.itemSize,offset:r.attributes.uv.offset,data:r.attributes.uv.array}),r.attributes.uv2&&(h.texCoord1={numComponents:r.attributes.uv2.itemSize,offset:r.attributes.uv2.offset,data:r.attributes.uv2.array}),this.bufferMeshDico[t.uuid]||(this.bufferMeshDico[t.uuid]=xe(this.gl,h)),ie(this.gl,e,this.bufferMeshDico[t.uuid]),ke.u_lightWorldPos=[n.matrixWorld[12],n.matrixWorld[13],n.matrixWorld[14]],ke.u_viewInverse=n.viewMatrix,se(e,{...ke,...c}),this.bufferMeshDico[t.uuid]}setMaterialBuffer(e,t,r){const{gl:n}=this,{material:s}=r,{normalTexture:o,occlusionTexture:i,emissiveFactor:a,emissiveTexture:l,alphaMode:u,alphaCutoff:c}=s,{baseColorFactor:h,baseColorTexture:d,metallicRoughnessTexture:m,metalness:p,roughness:f}=s.metallicRoughness,g={u_baseColorFactor:h,u_metalness:p,u_roughness:f,u_alpha:"OPAQUE"===u?0:c,u_emissiveFactor:a};d&&(g.u_baseColorTexture=this.createTexture(d.texture)),m&&(g.u_metallicRoughnessTexture=this.createTexture(m.texture)),l&&(g.u_emissiveTexture=this.createTexture(l.texture)),o&&(g.u_normalTexture=this.createTexture(o.texture)),i&&(g.occlusionTexture=this.createTexture(i.texture)),s.doubleSided&&this.glStatus[this.gl.CULL_FACE]?this.disableProperty(this.gl.CULL_FACE):s.doubleSided||this.glStatus[this.gl.CULL_FACE]||this.enableProperty(this.gl.CULL_FACE),se(e,{...g})}createBufferInfoFunc(e){return()=>{const t=e.apply(null,Array.prototype.slice.call(arguments,1));return xe(this.gl,t)}}createXYQuadVertices(e,t,r){return e=e||2,{position:{numComponents:2,data:[(t=t||0)+-1*(e*=.5),(r=r||0)+-1*e,t+1*e,r+-1*e,t+-1*e,r+1*e,t+1*e,r+1*e]},indices:[0,1,2,2,1,3]}}createXYQuadBufferInfo(){return this.createBufferInfoFunc(this.createXYQuadVertices)()}drawBufferInfo(e,t){!function(e,t,r,n,s){const{indices:o}=t;r=void 0===r?e.TRIANGLES:r;const i=void 0===n?t.numElements:n;s=void 0===s?0:s,o?e.drawElements(r,i,e.UNSIGNED_SHORT,s):e.drawArrays(r,s,i)}(e,t)}setCubeMapBuffer(e,t){const r=this.createCubeMapTexture(),n=p(t.viewMatrix);n[12]=0,n[13]=0,n[14]=0;const s=m(o(t.projectionMatrix,n));return ie(this.gl,e,this.quadBufferInfo),se(e,{u_viewDirectionProjectionInverse:s,u_cubeMap:r}),this.quadBufferInfo}}class Oe{container;gl;constructor(e,t){this.container=e,this.gl=t,this.renderStack={opaque:[],transmissive:[],transparent:[]},this.webglApiHelper=new De(this.gl)}render(e){let t=e.camera,r=e.scene,n=r.nodes;this.resizeCanvasToDisplaySize(this.gl.canvas),this.fillRenderStack(n),this.renderForPicking(r,t),this.renderMeshNodes(this.renderStack.opaque,t),this.renderMeshTransparentNodes(this.renderStack.transparent,t),this.cleanRenderStack()}resizeCanvasToDisplaySize(e){const t=e.clientWidth,r=e.clientHeight;return(e.width!==t||e.height!==r)&&(e.setAttribute("width",""+Math.floor(t)),e.setAttribute("height",""+Math.floor(r)),!0)}resize(){}clear(){this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}fillRenderStack(e){e.forEach((e=>{if(e.mesh){const{material:t}=e.mesh;t.alphaMode&&"BLEND"===t.alphaMode?this.renderStack.transparent.push(e):this.renderStack.opaque.push(e)}e.children&&this.fillRenderStack(e.children)}))}cleanRenderStack(){this.renderStack={opaque:[],transmissive:[],transparent:[]}}renderForPicking(){}renderCubeMap=function(e,t){const r=this.webglApiHelper,n=this.gl;n.viewport(0,0,n.canvas.clientWidth,n.canvas.clientHeight),r.disableProperty(n.BLEND),r.enableProperty(n.CULL_FACE),r.enableProperty(n.DEPTH_TEST),n.depthFunc(n.LEQUAL);const s=r.updateProgramCubeMap(),o=r.setCubeMapBuffer(s,t);r.drawBufferInfo(n,o)};renderMeshNodes(e,t){const r=this.gl;r.viewport(0,0,r.canvas.width,r.canvas.height),this.webglApiHelper.enableProperty(r.DEPTH_TEST),this.webglApiHelper.disableProperty(r.CULL_FACE),this.webglApiHelper.disableProperty(r.BLEND),r.depthFunc(r.LESS),e.forEach((e=>{this.renderMeshNode(e,t)}))}renderMeshTransparentNodes(){}renderMeshNode(e,t){const{mesh:r}=e;e.viewMatrix=o(e.matrixWorld,t.viewProjectionMatrix);const n=this.webglApiHelper,s=n.getProgramRef(e);if(s.needUpdate){const t=n.getGeometryProgramNeed(e,r),o=n.getMaterialProgramNeed(e,r);n.updateProgram(s,t,o)}const i=n.loadProgram(s),a=n.setGeometryBuffer(i,e,r,t);n.setMaterialBuffer(i,e,r);const{indices:l}=r;l?this.gl.drawElements(r.mode,a.numElements,l.componentType,0):this.gl.drawArrays(r.mode,0,a.numElements)}}class ze{canvas;context;width;height;offsetLeft;offsetTop;contextType;uuid;constructor(e,t){this.container=e,this.contextType=t,this.uuid=g(),this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.display="block",this.canvas.setAttribute("id",`${this.contextType}_${this.uuid}`),"2d"===this.contextType?this.getContext2D():this.getContextWebgl()}getContextWebgl(){this.context=this.canvas.getContext("webgl")}getContext2D(){this.context=this.canvas.getContext("2d")}detach(){this.canvas.remove()}}class Xe{element;layers;constructor(e){this.element=e,this.layers=[]}addWebglLayer(){const e=new ze(this.element,"webgl");return this.layers.push(e),e.context}addCanvas2DLayer(){const e=new ze(this.element,"2d");return this.layers.push(e),e.context}removeLayerByIndex(e){this.layers.splice(e,1)[0].detach()}destroy(){this.layers.forEach((e=>{e.context instanceof WebGLRenderingContext&&e.context.getExtension("WEBGL_lose_context").loseContext(),e.detach()}))}}class Ve{rendererContainer;containerHtml;webglRenderer;gl;constructor(e){this.rendererContainer=new Xe(e),this.gl=this.rendererContainer.addWebglLayer(),this.webglRenderer=new Oe(this.rendererContainer,this.gl)}render(e){this.webglRenderer.render(e)}resize(){this.webglRenderer.resize()}clear(){this.webglRenderer.clear()}destroy(){this.rendererContainer.destroy()}}class Ge{controller;constructor(e){this.controller=e}}class je extends Ge{gamepadId;action;type;index;value;constructor(e,t,r,n,s){super("gamepad"),this.gamepadId=e,this.type=t,this.index=r,this.action=n,this.value=s}}class We{logger;onInput;gamepads;gamepadTimestamps;constructor(e,t){this.inputs=[],this.onInput=e,this.logger=t,this.gamepads=[],this.gamepadTimestamps=[],this.logger.debug("new Gamepad controler"),this.init()}fetchInputs(){this.pollGamepad();for(let e=0;e<this.gamepads.length;e++){let t=this.gamepads[e];void 0!==this.gamepadTimestamps[e]&&t.timestamp!==this.gamepadTimestamps[e]&&(this.gamepadTimestamps[e]=t.timestamp,this.pollAxis(t,e),this.pollButtonsPressed(t,e))}}pollGamepad(){for(var e=navigator.getGamepads(),t=0;t<e.length;t++){let r=e[t];r&&(this.gamepads[t]=r)}}pollAxis(e,t){let r=e.axes;for(let e=0;e<r.length;e++){let n=new je(t,"axes",e,"move",r[e]);this.sendInput(n)}}pollButtonsPressed(e,t){let r=e.buttons;for(let e=0;e<r.length;e++){const n=r[e];if(n.pressed){let r=new je(t,"buttons",e,"pressed",n.value);this.sendInput(r)}}}init(){window.addEventListener("gamepadconnected",this.onGamepadConnect.bind(this),!1),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnect.bind(this),!1)}destroy(){window.removeEventListener("gamepadconnected",this.onGamepadConnect.bind(this),!1),window.removeEventListener("gamepaddisconnected",this.onGamepadDisconnect.bind(this),!1)}sendInput(e){this.onInput(e)}onGamepadConnect(e){var t=e.gamepad;this.gamepads[e.gamepad.id]=t}onGamepadDisconnect(e){this.gamepads[e.gamepad.id]=null}}class $e extends Ge{action;input;event;constructor(e,t,r){super("keyboard"),this.action=e,this.input=t,this.event=r}}class He{logger;onInput;container;constructor(e=document.body,t,r){this.inputs=[],this.container=e,this.onInput=t,this.logger=r,this.listenEvent(),this.logger.debug("new keyboard controler")}listenEvent(){document.body.addEventListener("keydown",this.keyDownHandler.bind(this),!1),document.body.addEventListener("keyup",this.keyUpHandler.bind(this),!1)}destroy(){document.body.removeEventListener("keydown",this.keyDownHandler.bind(this),!1),document.body.removeEventListener("keyup",this.keyUpHandler.bind(this),!1)}keyDownHandler(e){let t=new $e("down",e.key,e);this.sendInput(t)}keyUpHandler(e){let t=new $e("up",e.key,e);this.sendInput(t)}sendInput(e){this.onInput(e)}}class qe extends Ge{action;input;value;event;constructor(e,t,r,n){super("mouse"),this.action=e,this.input=t,this.value=r,this.event=n}}class Ye{logger;onInput;constructor(e=document.body,t,r){this.container=e,this.onInput=t,this.logger=r,this.listenEvent(),this.logger.debug("new  mouse controler")}listenEvent(){this.container.addEventListener("contextmenu",this.handleContextMenu.bind(this)),this.container.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.container.addEventListener("mouseenter",this.handleMouseEnter.bind(this)),this.container.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.container.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.container.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.container.addEventListener("wheel",this.handleMouseWheel.bind(this))}destroy(){this.container.removeEventListener("contextmenu",this.handleContextMenu.bind(this)),this.container.removeEventListener("mousedown",this.handleMouseDown.bind(this)),this.container.removeEventListener("mouseenter",this.handleMouseEnter.bind(this)),this.container.removeEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.container.removeEventListener("mousemove",this.handleMouseMove.bind(this)),this.container.removeEventListener("mouseup",this.handleMouseUp.bind(this)),this.container.removeEventListener("wheel",this.handleMouseWheel.bind(this))}handleContextMenu(e){const t=e.target.getBoundingClientRect();let r={x:e.clientX-t.left,y:e.clientY-t.top},n=new qe("contextMenu",null,r,e);this.sendInput(n)}handleMouseDown(e){const t=e.target.getBoundingClientRect();let r={x:e.clientX-t.left,y:e.clientY-t.top},n=new qe("down",e.button,r,e);this.sendInput(n)}handleMouseEnter(e){const t=e.target.getBoundingClientRect();let r={x:e.clientX-t.left,y:e.clientY-t.top},n=new qe("enter",null,r,e);this.sendInput(n)}handleMouseLeave(e){let t=new qe("leave",null,null,e);this.sendInput(t)}handleMouseMove(e){const t=e.target.getBoundingClientRect();let r={x:e.clientX-t.left,y:e.clientY-t.top},n=new qe("move",e.button,r,e);this.sendInput(n)}handleMouseUp(e){const t=e.target.getBoundingClientRect();e.clientX,t.left,e.clientY,t.top;let r=new qe("up",e.button,null,e);this.sendInput(r)}handleMouseWheel(e){let t={x:e.deltaX,y:e.deltaY},r=new qe("wheel",e.button,t,e);this.sendInput(r)}sendInput(e){this.onInput(e)}}class Je{logger;container;controls;inputs;constructor(e,t,r){this.inputs=[],this.logger=r,e=e??{gamepad:!0,keyboard:!0,mouse:!0},this.container=t,this.gamepads=e.gamepad?new We(this.onInput.bind(this),this.logger):null,this.keyboard=e.keyboard?new He(this.container,this.onInput.bind(this),this.logger):null,this.mouse=e.mouse?new Ye(this.container,this.onInput.bind(this),this.logger):null,this.logger.debug("new  controls "+e)}onInput(e){this.inputs.push(e)}getInputs(){return this.gamepads&&this.gamepads.fetchInputs(),this.inputs}clearInputs(){this.inputs=[]}destroy(){this.gamepads&&this.gamepads.destroy(),this.keyboard&&this.keyboard.destroy(),this.mouse&&this.mouse.destroy()}}class Ze{constructor(){}destroy(){}}class Qe{silent;secureLog;constructor(e=!1){this.secureLog=e?this.secureLogSilent:this.secureLogActivate}secureLogActivate(e,t){try{this.silent||console[e](t)}catch(e){console.error(e)}}secureLogSilent(){}trace(e){this.secureLog("trace",e)}time(e){this.secureLog("time",e)}timeEnd(e){this.secureLog("timeEnd",e)}debug(e){this.secureLog("debug",e)}log(e){this.secureLog("log",e)}info(e){this.secureLog("info",e)}warn(e){this.secureLog("warn",e)}error(e){this.secureLog("error",e)}destroy(){}}class Ke{uuid;audioService;controllers;loop;renderer;physics;loader;logger;engine;constructor(){this.uuid=g()}setAudioService(e){this.audioService=e}getAudioService(){return this.audioService}setEngine(e){this.engine=e}getEngine(){return this.engine}setControllers(e){this.controllers=e}getControllers(){return this.controllers}setRenderer(e){this.renderer=e}getRenderer(){return this.renderer}setPhysics(e){this.physics=e}getPhysic(){return this.physics}setLoop(e){this.loop=e}getLoop(){return this.loop}setLoader(e){this.loader=e}getLoader(){return this.loader}setLogger(e){this.logger=e}getLogger(){return this.logger}destroy(){this.renderer&&this.renderer.destroy(),this.loop&&this.loop.destroy(),this.physics&&this.physics.destroy(),this.controllers&&this.controllers.destroy(),this.audioService&&this.audioService.destroy(),this.loader&&this.loader.destroy(),this.logger&&this.logger.destroy()}}class et{container;level;gameState;gameStateSave;constructor({container:e=document.body,level:t,gameState:r,loadLevel:n}){this.container=e,this.level=t,this.gameState=r,this.loadLevel=n,this.start()}start(){let e=new Qe,t=new Je(null,this.container,e),r=new Z,n=new Ve(this.container),s=new J({logger:e}),o=new Ze;this.serviceLocator=new Ke,this.serviceLocator.setEngine(this),this.serviceLocator.setAudioService(r),this.serviceLocator.setControllers(t),this.serviceLocator.setRenderer(n),this.serviceLocator.setLoop(s),this.serviceLocator.setPhysics(o),this.serviceLocator.setLogger(e),this.serviceLocator.getLoop().setUpdate((()=>{this.gameState.inputs=this.serviceLocator.getControllers().getInputs(),this.level.systems.update(this.serviceLocator,this.level,this.gameState),this.level.scene.update(),this.level.camera.update(this.serviceLocator.getRenderer().gl),this.gameState.actions={},this.gameState.inputs.length=0,this.serviceLocator.getAudioService().update(this.gameState.soundCommands),this.gameState.inputs.length=0})),this.serviceLocator.getLoop().setRender((()=>{this.serviceLocator.getRenderer().render(this.level)})),this.serviceLocator.getLoop().play()}stop(){this.serviceLocator.getLoop().setUpdate((()=>{console.log("destroy update"),this.serviceLocator.getLoop().setUpdate((()=>{console.log("update empty")})),this.destroy(),this.loadLevel()})),this.serviceLocator.getLoop().setRender((()=>{console.log("render empty")}))}destroy(){console.log("destroy3"),this.serviceLocator.destroy(),delete this.serviceLocator,delete this.engine,this.gameState.temp={}}restart(){this.stop()}}const tt=e.p+"aceb11b1d3f62cf49c49ac548ec3fdee.mp3",rt=document.querySelector(".game-container"),nt=new class{constructor({state:e}){this.sceneIndex=0,this.inputs=[],this.actions={},this.soundCommands=[],this.state={},this.temp={},e&&(this.state={...e,...this.state})}save(){}load(){}}({}),st=new class{fileManager;constructor({root:e}){this.fileManager=new Y,this.root=e,this.gameDefinition=null,this.levelLoader=new W(this.fileManager)}load=function(e){return new Promise((async t=>{await this.fileManager.downloadRootFile(this.root),this.gameDefinition=await this.fileManager.downloadGameFile(),this.levelDefinition=await this.fileManager.downloadLevelFile(this.getDefaultLevelName());let r=await this.levelLoader.load(JSON.parse(JSON.stringify(this.levelDefinition)));if("number"==typeof r.camera&&!r.cameras[r.camera]){const e=new x({name:"defaultCamera",type:"perspective"}),t=new v;t.camera=e,e.node=t,r.cameras.set(e.uuid,e),r.camera=e,r.scene.nodes.push(t)}t({game:this.gameDefinition,level:r,state:e})}))};getDefaultLevelName(){return"number"==typeof this.gameDefinition.level||this.gameDefinition.levels[0]}}({root:"db_files"}),ot=function(){document.querySelector(".splashScreen").style.display=null,nt.soundCommands.push({src:tt,loop:!0}),st.load(nt).then((e=>{setTimeout((()=>{document.querySelector(".splashScreen").style.display="none";const t=new et({container:rt,level:e.level,gameState:e.state,loadLevel:ot});window._game_engine=t}),2e3)})).catch((e=>{throw window.alert("Error during game download"),e}))};ot()})();